# 成语接龙加星方案设计

## 一、当前问题分析

现有计算逻辑过于简单：
```dart
stars = (chainLength / 3) + (grade * 2)
```
- 缺乏激励机制
- 没有考虑游戏表现
- 星星通胀严重

---

## 二、设计目标

1. **激励持续游戏** - 接龙越长，奖励越高
2. **奖励优秀表现** - 快速回答、少用提示有额外奖励
3. **平衡难度差异** - 高年级难度大，基础奖励更高
4. **控制星星经济** - 避免通胀，保持星星价值

---

## 三、加星方案

### 3.1 基础星星（Base Stars）

| 接龙长度 | 基础星星 | 说明 |
|---------|---------|------|
| 1-2 回合 | 0 ⭐ | 热身阶段，不奖励 |
| 3-5 回合 | 1 ⭐ | 入门水平 |
| 6-9 回合 | 2 ⭐ | 良好表现 |
| 10-14 回合 | 3 ⭐ | 优秀表现 |
| 15-19 回合 | 5 ⭐ | 精英水平 |
| 20+ 回合 | 8 ⭐ | 大师级别 |

### 3.2 年级系数（Grade Multiplier）

| 年级 | 系数 | 说明 |
|-----|------|------|
| 1-2 年级 | ×1.0 | 基础难度 |
| 3-4 年级 | ×1.2 | 中等难度 |
| 5-6 年级 | ×1.5 | 较高难度 |
| 初中 (7-9) | ×2.0 | 高难度 |
| 高中 (10-12) | ×2.5 | 专家难度 |

### 3.3 表现奖励（Performance Bonus）

#### 速度奖励
| 平均回答时间 | 奖励 |
|-------------|------|
| < 3 秒 | +2 ⭐ |
| 3-5 秒 | +1 ⭐ |
| > 5 秒 | +0 ⭐ |

#### 提示惩罚
| 使用提示次数 | 扣减 |
|-------------|------|
| 0 次 | +1 ⭐ (完美奖励) |
| 1 次 | 0 |
| 2 次 | -1 ⭐ |
| 3+ 次 | -2 ⭐ |

### 3.4 特殊成就奖励

| 成就 | 奖励 | 触发条件 |
|-----|------|---------|
| 🏆 AI认输 | +5 ⭐ | AI找不到可接成语 |
| 🔥 连击大师 | +2 ⭐ | 连续5次3秒内回答 |
| 📚 生僻达人 | +3 ⭐ | 使用3个以上生僻成语 |
| ⚡ 闪电战 | +2 ⭐ | 全程无超时警告 |

---

## 四、计算公式

```
最终星星 = max(0, (基础星星 × 年级系数) + 速度奖励 - 提示惩罚 + 成就奖励)
```

### 示例计算

**场景**: 5年级学生，接龙12回合，平均4秒回答，用了1次提示

```
基础星星 = 3 (10-14回合)
年级系数 = 1.5 (5年级)
速度奖励 = 1 (3-5秒)
提示惩罚 = 0 (1次)
成就奖励 = 0

最终 = (3 × 1.5) + 1 - 0 + 0 = 5.5 → 取整 = 5 ⭐
```

---

## 五、星级评价（用于关卡解锁）

| 评价 | 条件 | 解锁效果 |
|-----|------|---------|
| ⭐ | 完成3回合 | 记录存档 |
| ⭐⭐ | 完成6回合 | 解锁下一关 |
| ⭐⭐⭐ | 完成10回合或AI认输 | 完美通关 |

---

## 六、数据追踪需求

需要记录以下数据用于计算：

1. `chainLength` - 接龙总长度
2. `totalTime` - 游戏总时长
3. `playerTurns` - 玩家回合数
4. `hintsUsed` - 使用提示次数
5. `fastAnswers` - 快速回答次数（<3秒）
6. `rareIdiomsUsed` - 使用的生僻成语数
7. `isAiSurrender` - AI是否认输
8. `timeoutWarnings` - 超时警告次数

---

## 七、UI 展示建议

### 游戏结束弹窗

```
┌─────────────────────────────┐
│      🎉 游戏结束！          │
│                             │
│   接龙长度: 12 回合         │
│   ─────────────────         │
│   基础奖励    3 ⭐           │
│   年级加成   +1.5 ⭐         │
│   速度奖励   +1 ⭐           │
│   ─────────────────         │
│   总计获得   ⭐⭐⭐⭐⭐ 5星    │
│                             │
│  [再来一局]    [返回首页]    │
└─────────────────────────────┘
```

---

## 八、实现优先级

### P0 - 核心功能
- [ ] 基础星星计算（按接龙长度）
- [ ] 年级系数应用
- [ ] 星级评价（1-3星）

### P1 - 表现奖励
- [ ] 提示惩罚机制
- [ ] AI认输奖励

### P2 - 进阶功能
- [ ] 速度奖励（需要追踪每回合时间）
- [ ] 特殊成就系统
- [ ] 详细结算UI

---

## 九、代码修改点

1. **IdiomGameState** - 新增追踪字段
2. **IdiomGameService.calculateStars()** - 重写计算逻辑
3. **GameResultDialog** - 展示详细结算
4. **IdiomGameRecords 表** - 新增统计字段

---

## 十、补充优化建议 (Refinement Suggestions)

### 10.1 逻辑与算法优化
- **改“平均时耗”为“快速回答次数”**: 避免单次回合分心或卡顿导致整体成绩骤降。建议：每 3 次“闪电回答”（<3秒）额外奖励 1 ⭐。
- **动态星级门槛**: 3 星门槛应随年级递增。例如：一年级 8 回合可得 3 星，高中需 15 回合。
- **星星经济防通胀**: 
    - 增加**每日获取上限**。
    - **收益递减**: 同一关卡重复挑战，从第二次起基础奖励减半。

### 10.2 用户体验 (UX) 增强
- **实时正向反馈**: 在对局中触发“连击”或“快速回答”时，立即在屏幕中心弹出金色文字特效（如：“🔥 连击 X5!”），提供即时多巴胺反馈。
- **AI 拟人化反馈**: AI 认输时，头像切换为“求饶/流汗”表情，文案更具互动性（如：“你太博学了，我认输！”）。
- **分项跳动计分**: 结算弹窗采用动效，逐项展示基础分、年级加成、成就奖励，最后汇总，增强仪式感。

### 10.3 技术方案建议
- **数据库表升级**: `idiom_game_records` 需扩展 `hints_used`, `fast_answer_count`, `is_ai_surrender` 等字段以支持历史回溯。
- **状态机增强**: `IdiomGameState` 增加 `turnStartTime` 记录，用于精准计算单回合用时。

---

*文档更新时间: 2024-12-24*
*状态: 待实现*
