# æˆè¯­è¡¥å…¨é”™é¢˜æœ¬è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€æ•°æ®æ¨¡å‹

### é”™é¢˜è®°å½•è¡¨ (idiom_engagement_records)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| childId | int | å­©å­ID |
| idiomId | int | æˆè¯­ID |
| encounterCount | int | é‡åˆ°æ¬¡æ•° |
| correctCount | int | æ­£ç¡®æ¬¡æ•° |
| failCount | int | é”™è¯¯æ¬¡æ•° |
| lastFailedAt | DateTime? | æœ€è¿‘é”™è¯¯æ—¶é—´ |
| masteryLevel | int | æŒæ¡ç­‰çº§ (0-3) |
| consecutiveCorrect | int | è¿ç»­æ­£ç¡®æ¬¡æ•° |

### æŒæ¡ç­‰çº§å®šä¹‰

| ç­‰çº§ | åç§° | æ¡ä»¶ | å¤ä¹ é¢‘ç‡ |
|------|------|------|----------|
| 0 | æœªæŒæ¡ | ä»æœªç­”å¯¹ | æ¯å±€å¿…å‡º |
| 1 | åˆè¯† | ç­”å¯¹1æ¬¡ | é«˜é¢‘å¤ä¹  |
| 2 | ç†Ÿæ‚‰ | è¿ç»­ç­”å¯¹2æ¬¡ | ä¸­é¢‘å¤ä¹  |
| 3 | æŒæ¡ | è¿ç»­ç­”å¯¹3æ¬¡ | ä½é¢‘/ä¸å‡º |

---

## äºŒã€é”™é¢˜æœ¬ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– é”™é¢˜æœ¬          ç­›é€‰ â–¼      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¾…å¤ä¹ ï¼š12ä¸ª  å·²æŒæ¡ï¼š45ä¸ª      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ©è€³ç›—é“ƒ                 â”‚   â”‚
â”‚  â”‚ yÇn Ä›r dÃ o lÃ­ng        â”‚   â”‚
â”‚  â”‚ âŒ é”™3æ¬¡  âœ“ å¯¹1æ¬¡       â”‚   â”‚
â”‚  â”‚ ğŸ”´ æœªæŒæ¡  æœ€è¿‘ï¼šä»Šå¤©     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç”»è›‡æ·»è¶³                 â”‚   â”‚
â”‚  â”‚ huÃ  shÃ© tiÄn zÃº        â”‚   â”‚
â”‚  â”‚ âŒ é”™2æ¬¡  âœ“ å¯¹2æ¬¡       â”‚   â”‚
â”‚  â”‚ ğŸŸ¡ åˆè¯†   æœ€è¿‘ï¼šæ˜¨å¤©     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚
â”‚  [å¼€å§‹å¤ä¹  (12é¢˜)]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å¤ä¹ æ¨¡å¼

### 1. æ™ºèƒ½å¤ä¹ é˜Ÿåˆ—

```
ä¼˜å…ˆçº§ = åŸºç¡€åˆ† + æ—¶é—´è¡°å‡ + é”™è¯¯æƒé‡

åŸºç¡€åˆ†ï¼š
- æœªæŒæ¡(0çº§)ï¼š100åˆ†
- åˆè¯†(1çº§)ï¼š60åˆ†
- ç†Ÿæ‚‰(2çº§)ï¼š30åˆ†
- æŒæ¡(3çº§)ï¼š0åˆ†

æ—¶é—´è¡°å‡ï¼š
- è·ä¸Šæ¬¡é”™è¯¯ <1å¤©ï¼š+20åˆ†
- è·ä¸Šæ¬¡é”™è¯¯ 1-3å¤©ï¼š+10åˆ†
- è·ä¸Šæ¬¡é”™è¯¯ >7å¤©ï¼š+0åˆ†

é”™è¯¯æƒé‡ï¼š
- é”™è¯¯æ¬¡æ•° Ã— 5åˆ†
```

### 2. å¤ä¹ è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| æ¯å±€é¢˜æ•° | 10é¢˜ï¼ˆä¸æ­£å¸¸æ¨¡å¼ä¸€è‡´ï¼‰ |
| é¢˜ç›®æ¥æº | 100% æ¥è‡ªé”™é¢˜æœ¬ |
| æ˜Ÿæ˜Ÿå¥–åŠ± | æ­£å¸¸è®¡ç®—ï¼ˆé¼“åŠ±å¤ä¹ ï¼‰ |
| å‡çº§æ¡ä»¶ | è¿ç»­ç­”å¯¹ â†’ æŒæ¡ç­‰çº§+1 |
| é™çº§æ¡ä»¶ | ç­”é”™ â†’ æŒæ¡ç­‰çº§å½’0 |

### 3. å¤ä¹ å®Œæˆåé¦ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ“š å¤ä¹ å®Œæˆï¼            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ¬æ¬¡å¤ä¹ ï¼š10ä¸ªæˆè¯­             â”‚
â”‚  ç­”å¯¹ï¼š8ä¸ª  ç­”é”™ï¼š2ä¸ª           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‰ æ–°æŒæ¡ï¼š3ä¸ª                 â”‚
â”‚     Â· æ©è€³ç›—é“ƒ (0â†’3)           â”‚
â”‚     Â· ç”»è›‡æ·»è¶³ (1â†’3)           â”‚
â”‚     Â· å®ˆæ ªå¾…å…” (2â†’3)           â”‚
â”‚                                 â”‚
â”‚  âš ï¸ ä»éœ€åŠ å¼ºï¼š2ä¸ª               â”‚
â”‚     Â· äº¡ç¾Šè¡¥ç‰¢ (1â†’0)           â”‚
â”‚     Â· åˆ»èˆŸæ±‚å‰‘ (2â†’0)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¾…å¤ä¹ ï¼š9ä¸ª â†’ 8ä¸ª (-1)         â”‚
â”‚  å·²æŒæ¡ï¼š45ä¸ª â†’ 48ä¸ª (+3)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

### 1. é”™é¢˜è‡ªåŠ¨æ”¶é›†

```dart
// ç­”é”™æ—¶è‡ªåŠ¨è®°å½•
void onAnswerWrong(int childId, int idiomId) {
  engagementDao.upsertEngagement(
    childId, idiomId,
    isCorrect: false,
  );
}
```

### 2. æ­£å¸¸æ¨¡å¼æ··å…¥é”™é¢˜

| åœºæ™¯ | é”™é¢˜æ··å…¥æ¯”ä¾‹ |
|------|-------------|
| æ­£å¸¸æ¸¸æˆ | 30% æ¥è‡ªé”™é¢˜æœ¬ |
| å¤ä¹ æ¨¡å¼ | 100% æ¥è‡ªé”™é¢˜æœ¬ |

### 3. å…¥å£ä½ç½®

- æ¸¸æˆå¤§å… â†’ é”™é¢˜æœ¬å…¥å£
- ç»“ç®—ç•Œé¢ â†’ "æŸ¥çœ‹é”™é¢˜"æŒ‰é’®
- æˆè¯­è¯¦æƒ… â†’ æ ‡è®°"å·²åŠ å…¥é”™é¢˜æœ¬"

---

## äº”ã€æ•°æ®åº“å˜æ›´

éœ€è¦åœ¨ `idiom_engagement_records` è¡¨æ·»åŠ å­—æ®µï¼š

```dart
// tables.dart æ–°å¢å­—æ®µ
DateTimeColumn get lastFailedAt => dateTime().nullable()();
IntColumn get masteryLevel => integer().withDefault(const Constant(0))();
IntColumn get consecutiveCorrect => integer().withDefault(const Constant(0))();
```

---

## å…­ã€åŠŸèƒ½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | è¯´æ˜ |
|--------|------|------|
| P0 | é”™é¢˜è‡ªåŠ¨æ”¶é›† | ç­”é”™æ—¶è®°å½• |
| P0 | é”™é¢˜æœ¬åˆ—è¡¨ | å±•ç¤ºæ‰€æœ‰é”™é¢˜ |
| P1 | å¤ä¹ æ¨¡å¼ | ä¸“é¡¹å¤ä¹ é”™é¢˜ |
| P1 | æŒæ¡ç­‰çº§ | è¿½è¸ªå­¦ä¹ è¿›åº¦ |
| P2 | æ™ºèƒ½æ’åº | ä¼˜å…ˆå¤ä¹ è–„å¼±é¡¹ |
| P2 | å¤ä¹ æé†’ | å®šæ—¶æ¨é€å¤ä¹  |

---

## ä¸ƒã€DAO æ¥å£è®¾è®¡

```dart
class IdiomEngagementDao {
  /// è·å–å¾…å¤ä¹ æˆè¯­ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
  Future<List<IdiomEngagement>> getReviewQueue(int childId, {int limit = 10});

  /// è·å–é”™é¢˜ç»Ÿè®¡
  Future<MistakeStats> getMistakeStats(int childId);

  /// æ›´æ–°æŒæ¡ç­‰çº§
  Future<void> updateMasteryLevel(int childId, int idiomId, bool isCorrect);

  /// è·å–æŒ‡å®šæŒæ¡ç­‰çº§çš„æˆè¯­
  Future<List<IdiomEngagement>> getByMasteryLevel(int childId, int level);
}
```
